<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin panel</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; background:#f5f5f5; }
    h1 { margin: 0 0 12px; }
    .card { background:#fff; padding:14px 16px; border-radius:10px; margin: 0 0 14px; border:1px solid #e6e6e6; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width: 240px; }
    button { padding:8px 10px; border:1px solid #bbb; border-radius:8px; cursor:pointer; background:#fafafa; }
    pre { background:#f0f0f0; padding:10px; border-radius:10px; overflow:auto; }
    .muted { color:#666; font-size: 13px; }
    .ok { color:#0a7a2f; font-weight:600; }
    .bad { color:#b00020; font-weight:600; }
  </style>
</head>
<body>

<h1>Admin panel</h1>

<div class="card">
  <div class="row">
    <b>API URL:</b>
    <input id="apiUrl" />
    <button id="saveApi">Save</button>
  </div>
  <div class="muted">Порада: якщо міняли бекенд/домен — поміняйте тут і натисніть Save.</div>
</div>

<div class="card">
  <div class="row">
    <div id="tgLogin"></div>
    <div class="muted">Логін через Telegram</div>
  </div>
  <div id="loginStatus" class="muted">Не залогінено</div>
</div>

<div class="card">
  <div class="row">
    <b>Admin:</b> <span id="adminId">—</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 10px;">User</h3>
  <div class="row">
    <input id="userId" placeholder="telegram_user_id" />
    <button id="loadBtn">Load</button>
  </div>
  <div class="muted">Load читає /public/users/:id (без токена), щоб бачити актуальний баланс.</div>
  <pre id="userData">—</pre>
</div>

<div class="card">
  <h3 style="margin:0 0 10px;">Actions</h3>
  <div class="row">
    <input id="starsAmount" placeholder="Stars amount" />
    <button id="giveStarsBtn">Give stars</button>
  </div>
  <div class="row">
    <input id="cashAmount" placeholder="Cash amount" />
    <button id="giveCashBtn">Give cash</button>
  </div>
  <div class="muted">Actions працюють через /admin/users/:id/actions і потребують токен.</div>
</div>

<div class="card">
  <h3 style="margin:0 0 10px;">Debug</h3>
  <pre id="debug">—</pre>
</div>

<script>
  // ===== CONFIG =====
  const DEFAULT_API = "https://boxing-manager-admin-api.onrender.com";
  const BOT_USERNAME = "boxing_manager_game_bot";

  let API = localStorage.getItem("admin_api_url") || DEFAULT_API;
  let token = localStorage.getItem("admin_jwt") || "";

  // ===== UI helpers =====
  const $ = (id) => document.getElementById(id);

  function setDebug(obj) {
    $("debug").textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
  }

  function setLoginState(ok, adminIdText) {
    if (ok) {
      $("loginStatus").innerHTML = `<span class="ok">Залогінено</span>`;
      $("adminId").textContent = adminIdText || "OK";
    } else {
      $("loginStatus").innerHTML = `<span class="bad">Не залогінено</span>`;
      $("adminId").textContent = "—";
    }
  }

  function authHeaders() {
    return token ? { "Authorization": "Bearer " + token } : {};
  }

  // ===== Save API URL =====
  $("apiUrl").value = API;
  $("saveApi").onclick = () => {
    API = $("apiUrl").value.trim().replace(/\/+$/, "");
    localStorage.setItem("admin_api_url", API);
    setDebug({ ok: true, api: API });
  };

  // ===== Logout =====
  $("logoutBtn").onclick = () => {
    localStorage.removeItem("admin_jwt");
    token = "";
    setLoginState(false);
    setDebug("Logged out");
  };

  // ===== Load user (PUBLIC) =====
  $("loadBtn").onclick = async () => {
    const id = $("userId").value.trim();
    if (!id) return setDebug("Enter telegram_user_id");

    try {
      const res = await fetch(`${API}/public/users/${encodeURIComponent(id)}?t=${Date.now()}`);
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }
      $("userData").textContent = JSON.stringify(json, null, 2);
      setDebug({ request: { url: res.url, method: "GET" }, response: { status: res.status, ok: res.ok, json } });
    } catch (e) {
      setDebug(String(e));
    }
  };

  // ===== Actions (ADMIN) =====
  async function postAction(action, payload) {
    const id = $("userId").value.trim();
    if (!id) return setDebug("Enter telegram_user_id");
    if (!token) return setDebug({ error: "No token (login first)" });

    const url = `${API}/admin/users/${encodeURIComponent(id)}/actions?t=${Date.now()}`;
    const body = JSON.stringify({ action, ...payload });

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { json = { raw: text }; }

    setDebug({
      request: { url, method: "POST", headers: { "Content-Type": "application/json", Authorization: token ? "Bearer <token>" : "" }, body },
      response: { status: res.status, ok: res.ok, json }
    });

    // refresh user view
    $("loadBtn").click();
  }

  $("giveStarsBtn").onclick = async () => {
    const amount = Number($("starsAmount").value);
    if (!Number.isFinite(amount)) return setDebug("Bad stars amount");
    await postAction("give_stars", { amount });
  };

  $("giveCashBtn").onclick = async () => {
    const amount = Number($("cashAmount").value);
    if (!Number.isFinite(amount)) return setDebug("Bad cash amount");
    await postAction("give_cash", { amount });
  };

  // ===== Telegram auth callback =====
  window.onTelegramAuth = async function (user) {
    // user includes: id, first_name, username, photo_url, auth_date, hash
    try {
      const url = `${API}/admin/auth/telegram?t=${Date.now()}`;

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user)
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }

      setDebug({
        request: { url, method: "POST", body: user },
        response: { status: res.status, ok: res.ok, json }
      });

      if (!res.ok || !json.token) {
        setLoginState(false);
        return;
      }

      token = json.token;
      localStorage.setItem("admin_jwt", token);
      setLoginState(true, String(user.id));
    } catch (e) {
      setLoginState(false);
      setDebug(String(e));
    }
  };

  // ===== Render Telegram widget =====
  (function renderWidget() {
    const wrap = $("tgLogin");
    wrap.innerHTML = "";

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://telegram.org/js/telegram-widget.js?22";
    s.setAttribute("data-telegram-login", BOT_USERNAME);
    s.setAttribute("data-size", "large");
    s.setAttribute("data-userpic", "true");
    s.setAttribute("data-request-access", "write");
    s.setAttribute("data-onauth", "onTelegramAuth(user)");
    wrap.appendChild(s);
  })();

  // restore state
  if (token) {
    setLoginState(true, "(saved token)");
  } else {
    setLoginState(false);
  }
</script>

</body>
</html>
