<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>Admin panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial; max-width: 980px; margin: 20px auto; padding: 0 12px; }
    .card { border: 1px solid #ccc; padding: 16px; margin-bottom: 16px; border-radius: 8px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input, button { padding: 8px; }
    pre { background: #f6f6f6; padding: 10px; border-radius: 6px; overflow:auto; }
    .muted { color: #666; }
    .ok { color: #1b5e20; }
    .err { color: #b71c1c; }
    code { background:#f1f1f1; padding:2px 6px; border-radius:4px; }
  </style>
</head>

<body>

<h1>Admin panel</h1>
<div class="muted">API: <code id="apiLabel"></code></div>

<div class="card">
  <div class="row">
    <label class="muted">API URL:</label>
    <input id="apiInput" style="min-width: 420px;" />
    <button onclick="saveApi()">Save</button>
  </div>
  <div class="muted">Порада: якщо Ви оновили бекенд/домен — поміняйте тут і натисніть Save.</div>
</div>

<!-- LOGIN -->
<div class="card">
  <script async
    src="https://telegram.org/js/telegram-widget.js?22"
    data-telegram-login="boxing_manager_game_bot"
    data-size="large"
    data-onauth="onTelegramAuth(user)">
  </script>
  <div id="loginStatus" class="muted">Не залогінено</div>
</div>

<!-- ADMIN -->
<div class="card" id="adminCard" style="display:none;">
  <div class="row">
    <div>Admin: <b id="adminInfo"></b></div>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<!-- USER -->
<div class="card" id="usersCard" style="display:none;">
  <h3>User</h3>
  <div class="row">
    <input id="userId" placeholder="telegram_user_id" />
    <button onclick="loadUser()">Load</button>
  </div>

  <div id="userMsg" class="muted"></div>
  <pre id="userResult"></pre>

  <h4>Actions</h4>
  <div class="row">
    <input id="starsAmount" placeholder="Stars" />
    <button onclick="giveStars()">Give stars</button>
  </div>
  <div class="row">
    <input id="cashAmount" placeholder="Cash" />
    <button onclick="giveCash()">Give cash</button>
  </div>

  <div id="actionMsg" class="muted"></div>

  <h4>Debug</h4>
  <pre id="debugBox"></pre>
</div>

<script>
let API = localStorage.getItem("admin_api") || "https://boxing-manager-admin-api.onrender.com";
let token = localStorage.getItem("admin_token");

const apiInput = document.getElementById("apiInput");
const apiLabel = document.getElementById("apiLabel");
apiInput.value = API;
apiLabel.textContent = API;

function saveApi() {
  API = apiInput.value.trim();
  localStorage.setItem("admin_api", API);
  apiLabel.textContent = API;
  setMsg("actionMsg", "Saved API URL", "ok");
}

function setMsg(id, text, cls) {
  const el = document.getElementById(id);
  el.className = cls || "muted";
  el.textContent = text || "";
}

function setDebug(obj) {
  document.getElementById("debugBox").textContent = typeof obj === "string"
    ? obj
    : JSON.stringify(obj, null, 2);
}

function authHeaders() {
  return token ? { "Authorization": "Bearer " + token } : {};
}

async function apiFetch(path, options = {}) {
  const url = API + path;
  const req = {
    url,
    method: options.method || "GET",
    headers: { "Content-Type": "application/json", ...authHeaders(), ...(options.headers||{}) },
    body: options.body
  };

  setDebug({ request: req });

  const res = await fetch(url, req);

  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch {}

  setDebug({
    request: req,
    response: {
      status: res.status,
      ok: res.ok,
      text,
      json
    }
  });

  if (!res.ok) {
    const msg = (json && json.error) ? json.error : text || "Request failed";
    throw new Error(msg);
  }

  return json ?? text;
}

window.onTelegramAuth = async (user) => {
  try {
    const res = await fetch(API + "/auth/telegram", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(user)
    });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    setDebug({
      request: { url: API + "/auth/telegram", method: "POST", body: user },
      response: { status: res.status, ok: res.ok, text, json: data }
    });

    if (!res.ok) throw new Error((data && data.error) ? data.error : text || "Auth failed");

    token = data.token;
    localStorage.setItem("admin_token", token);

    setMsg("loginStatus", "Залогінено", "ok");
    document.getElementById("adminInfo").textContent = user.id;

    document.getElementById("adminCard").style.display = "";
    document.getElementById("usersCard").style.display = "";
  } catch (e) {
    setMsg("loginStatus", e.message, "err");
  }
};

function logout() {
  localStorage.removeItem("admin_token");
  token = null;
  location.reload();
}

async function loadUser() {
  try {
    setMsg("userMsg", "Loading...", "muted");
    const id = document.getElementById("userId").value.trim();
    const data = await apiFetch("/admin/users/" + id);
    document.getElementById("userResult").textContent = JSON.stringify(data, null, 2);
    setMsg("userMsg", "OK", "ok");
  } catch (e) {
    document.getElementById("userResult").textContent = "";
    setMsg("userMsg", e.message, "err");
  }
}

async function giveStars() {
  try {
    setMsg("actionMsg", "Working...", "muted");
    const id = document.getElementById("userId").value.trim();
    const amount = Number(document.getElementById("starsAmount").value);
    const data = await apiFetch(`/admin/users/${id}/actions`, {
      method: "POST",
      body: JSON.stringify({ action: "give_stars", amount })
    });
    document.getElementById("userResult").textContent = JSON.stringify(data, null, 2);
    setMsg("actionMsg", "Stars updated", "ok");
  } catch (e) {
    setMsg("actionMsg", e.message, "err");
  }
}

async function giveCash() {
  try {
    setMsg("actionMsg", "Working...", "muted");
    const id = document.getElementById("userId").value.trim();
    const amount = Number(document.getElementById("cashAmount").value);
    const data = await apiFetch(`/admin/users/${id}/actions`, {
      method: "POST",
      body: JSON.stringify({ action: "give_cash", amount })
    });
    document.getElementById("userResult").textContent = JSON.stringify(data, null, 2);
    setMsg("actionMsg", "Cash updated", "ok");
  } catch (e) {
    setMsg("actionMsg", e.message, "err");
  }
}

if (token) {
  document.getElementById("adminCard").style.display = "";
  document.getElementById("usersCard").style.display = "";
  setMsg("loginStatus", "Залогінено (token)", "ok");
}
</script>

</body>
</html>
