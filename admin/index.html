<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boxing Manager — Admin</title>
  <style>
    body{font-family:Arial, sans-serif; max-width:980px; margin:24px auto; padding:0 16px;}
    .card{border:1px solid #ddd; border-radius:12px; padding:14px; margin:14px 0;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input, button, textarea{font-size:14px; padding:10px;}
    textarea{width:100%; min-height:220px;}
    pre{background:#f6f6f6; padding:12px; border-radius:12px; overflow:auto;}
    .muted{color:#666; font-size:12px;}
  </style>
</head>
<body>
  <h1>Admin</h1>
  <div class="muted">API: <span id="apiBase"></span></div>

  <div class="card" id="loginCard">
    <div class="row">
      <div id="tgLogin"></div>
      <div class="muted">Логін через Telegram</div>
    </div>
    <div class="muted" id="loginStatus">Не залогінено</div>
  </div>

  <div class="card" id="appCard" style="display:none;">
    <div class="row">
      <b id="adminInfo"></b>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="card" id="economyCard" style="display:none;">
    <h2>Economy</h2>
    <div class="row">
      <input id="econVersion" placeholder="version (наприклад 1.0.0)" />
      <button id="loadEconBtn">Load</button>
      <button id="saveEconBtn">Save</button>
    </div>
    <textarea id="econJson"></textarea>
    <pre id="econResult"></pre>
  </div>

  <div class="card" id="usersCard" style="display:none;">
    <h2>Users</h2>
    <div class="row">
      <input id="userId" placeholder="telegram_user_id" />
      <button id="loadUserBtn">Load user</button>
    </div>
    <pre id="userResult"></pre>

    <h3>Actions</h3>
    <div class="row">
      <input id="cashAmount" placeholder="give cash (e.g. 1000)" />
      <button id="giveCashBtn">Give cash</button>
    </div>

    <div class="row">
      <input id="vipDays" placeholder="VIP days (e.g. 7)" />
      <button id="setVipBtn">Set VIP</button>
    </div>

    <div class="row">
      <button id="banBtn">Ban</button>
      <button id="unbanBtn">Unban</button>
    </div>
  </div>

  <script>
    const API_BASE = "https://boxing-manager-admin-api.onrender.com";
    document.getElementById("apiBase").textContent = API_BASE;

    let token = localStorage.getItem("admin_token") || "";
    let admin = JSON.parse(localStorage.getItem("admin_info") || "null");

    function show(id, yes){ document.getElementById(id).style.display = yes ? "" : "none"; }
    function setText(id, t){ document.getElementById(id).textContent = t; }

    function refreshUI(){
      const logged = !!token;
      show("appCard", logged);
      show("economyCard", logged);
      show("usersCard", logged);
      setText("loginStatus", logged ? "Залогінено" : "Не залогінено");
      setText("adminInfo", `Admin: ${admin?.telegram_user_id || "?"}`);
    }

    async function api(path, opts={}){
      const headers = {"Content-Type":"application/json", ...(opts.headers||{})};
      if (token) headers.Authorization = "Bearer " + token;
      const res = await fetch(API_BASE + path, {...opts, headers});
      const txt = await res.text();
      let json; try{ json = JSON.parse(txt); } catch{ json = {raw:txt}; }
      if (!res.ok) throw new Error(json.error || ("HTTP " + res.status));
      return json;
    }

    document.getElementById("logoutBtn").onclick = () => {
      token = ""; admin = null;
      localStorage.removeItem("admin_token");
      localStorage.removeItem("admin_info");
      refreshUI();
    };

    // Economy
    document.getElementById("loadEconBtn").onclick = async () => {
      try{
        const econ = await api("/admin/economy");
        document.getElementById("econVersion").value = econ.version || "";
        document.getElementById("econJson").value = JSON.stringify(econ.value_json || {}, null, 2);
        document.getElementById("econResult").textContent = "Loaded.";
      }catch(e){
        document.getElementById("econResult").textContent = e.message;
      }
    };

    document.getElementById("saveEconBtn").onclick = async () => {
      try{
        const version = document.getElementById("econVersion").value.trim() || "0";
        const value_json = JSON.parse(document.getElementById("econJson").value || "{}");
        await api("/admin/economy", {method:"PUT", body: JSON.stringify({version, value_json})});
        document.getElementById("econResult").textContent = "Saved.";
      }catch(e){
        document.getElementById("econResult").textContent = e.message;
      }
    };

    // Users
    async function loadUser(){
      const id = document.getElementById("userId").value.trim();
      if (!id) throw new Error("Enter telegram_user_id");
      const u = await api("/admin/users/" + encodeURIComponent(id));
      document.getElementById("userResult").textContent = JSON.stringify(u, null, 2);
    }
    document.getElementById("loadUserBtn").onclick = async () => {
      try{ await loadUser(); } catch(e){ document.getElementById("userResult").textContent = e.message; }
    };

    document.getElementById("giveCashBtn").onclick = async () => {
      try{
        const id = document.getElementById("userId").value.trim();
        const amount = Number(document.getElementById("cashAmount").value || 0);
        await api(`/admin/users/${encodeURIComponent(id)}/actions`, {method:"POST", body: JSON.stringify({action:"give_cash", amount})});
        await loadUser();
      }catch(e){ document.getElementById("userResult").textContent = e.message; }
    };

    document.getElementById("setVipBtn").onclick = async () => {
      try{
        const id = document.getElementById("userId").value.trim();
        const vip_days = Number(document.getElementById("vipDays").value || 0);
        await api(`/admin/users/${encodeURIComponent(id)}/actions`, {method:"POST", body: JSON.stringify({action:"set_vip", vip_days})});
        await loadUser();
      }catch(e){ document.getElementById("userResult").textContent = e.message; }
    };

    document.getElementById("banBtn").onclick = async () => {
      try{
        const id = document.getElementById("userId").value.trim();
        await api(`/admin/users/${encodeURIComponent(id)}/actions`, {method:"POST", body: JSON.stringify({action:"set_ban", banned:true})});
        await loadUser();
      }catch(e){ document.getElementById("userResult").textContent = e.message; }
    };

    document.getElementById("unbanBtn").onclick = async () => {
      try{
        const id = document.getElementById("userId").value.trim();
        await api(`/admin/users/${encodeURIComponent(id)}/actions`, {method:"POST", body: JSON.stringify({action:"set_ban", banned:false})});
        await loadUser();
      }catch(e){ document.getElementById("userResult").textContent = e.message; }
    };

    // Telegram login
    window.onTelegramAuth = async (user) => {
      try{
        const res = await fetch(API_BASE + "/auth/telegram", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(user)
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || "Auth failed");
        token = json.token;
        admin = { telegram_user_id: user.id, username: user.username || null };
        localStorage.setItem("admin_token", token);
        localStorage.setItem("admin_info", JSON.stringify(admin));
        refreshUI();
      }catch(e){
        setText("loginStatus", e.message);
      }
    };

    // IMPORTANT: put your bot username here (without @)
    const BOT_USERNAME = "PASTE_YOUR_BOT_USERNAME_HERE";

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://telegram.org/js/telegram-widget.js?22";
    script.setAttribute("data-telegram-login", BOT_USERNAME);
    script.setAttribute("data-size", "large");
    script.setAttribute("data-onauth", "onTelegramAuth(user)");
    document.getElementById("tgLogin").appendChild(script);

    refreshUI();
  </script>
</body>
</html>
